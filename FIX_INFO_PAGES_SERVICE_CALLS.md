# ?? ????????? Info PR, PO, GR ???????? Service ????

## ??????????
???? Info ??????? 3 modules (PR, PO, GR) ???????:
1. ? ??? `IPurchasingService` ??????????? service ????????????? module
2. ? ??????????? service ?????? `OnPostAsync` (????? TODO comment)
3. ? ?????? load ????????? service ?? `OnGetAsync` ??????? id

## ???????? ?

### 1. Purchase Requisition (PR)
**????:** `EbikeRental.Web/Pages/Purchasing/PR/Info.cshtml.cs`

#### ?????????? Inject Service
```csharp
// ? ????
private readonly IPurchasingService _purchasingService;
public InfoModel(IPurchasingService purchasingService, ...)

// ? ????
private readonly IPurchaseRequisitionService _prService;
public InfoModel(IPurchaseRequisitionService prService, ...)
```

#### ????? Using Statement
```csharp
using System.Security.Claims;
```

#### ????? OnGetAsync - Load PR ?????????
```csharp
if (id.HasValue)
{
    var result = await _prService.GetByIdAsync(id.Value);
    if (result.Success && result.Data != null)
    {
        PR = result.Data;
    }
    else
    {
        TempData["ErrorMessage"] = result.Message;
        RedirectToPage("./Index");
    }
}
```

#### ????? OnPostAsync - Create ??? Update ????
```csharp
var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "0");

if (PR.Id == 0)
{
    // Create
    var result = await _prService.CreateAsync(PR, userId);
    if (result.Success)
    {
        TempData["SuccessMessage"] = result.Message;
        return RedirectToPage("./Index");
    }
    else
    {
        TempData["ErrorMessage"] = result.Message;
        await LoadItems();
        return Page();
    }
}
else
{
    // Update
    var result = await _prService.UpdateAsync(PR.Id, PR, userId);
    if (result.Success)
    {
        TempData["SuccessMessage"] = result.Message;
        return RedirectToPage("./Index");
    }
    else
    {
        TempData["ErrorMessage"] = result.Message;
        await LoadItems();
        return Page();
    }
}
```

---

### 2. Purchase Order (PO)
**????:** `EbikeRental.Web/Pages/Purchasing/PO/Info.cshtml.cs`

#### ?????????? Inject Service
```csharp
// ? ????
private readonly IPurchasingService _purchasingService;

// ? ????
private readonly IPurchaseOrderService _poService;
```

#### ?????????????? PR
- ????? `using System.Security.Claims;`
- Load PO ????????????? `_poService.GetByIdAsync()`
- Create/Update ???? `_poService.CreateAsync()` ??? `_poService.UpdateAsync()`
- ??? userId ??? Claims
- Error handling ??????????

---

### 3. Goods Receipt (GR)
**????:** `EbikeRental.Web/Pages/Purchasing/GR/Info.cshtml.cs`

#### ?????????? Inject Service
```csharp
// ? ????
private readonly IPurchasingService _purchasingService;

// ? ????
private readonly IGoodsReceiptService _grService;
```

#### ?????????????? PR ??? PO
- ????? `using System.Security.Claims;`
- Load GR ????????????? `_grService.GetByIdAsync()`
- Create/Update ???? `_grService.CreateAsync()` ??? `_grService.UpdateAsync()`
- ??? userId ??? Claims
- Error handling ??????????

---

## ????????????

### ? ??? Inject Service ??????????
- PR ? `IPurchaseRequisitionService`
- PO ? `IPurchaseOrderService`
- GR ? `IGoodsReceiptService`

### ? OnGetAsync - Load ??????????
- ??????? `id` ??????? `GetByIdAsync()` ???????????????
- ???? error message ??????????????
- DocumentNumber ???? "Auto-generated" ?????? record ????

### ? OnPostAsync - ????????????????
- ??? `userId` ??? `User.FindFirstValue(ClaimTypes.NameIdentifier)`
- ????? `CreateAsync()` ?????? record ???? (Id == 0)
- ????? `UpdateAsync()` ?????? record ?????????
- ???? success/error message ??????????
- Reload items/warehouses ????????? error

### ? Error Handling
- ??????? `result.Success` ??? `result.IsSuccess`
- ???? `result.Message` ??? `result.ErrorMessage`
- Reload dropdown data ????????? error ???????????????? submit ???????

---

## ??????????? Result Class

```csharp
public class Result
{
    public bool Success { get; set; }      // ?????? IsSuccess
    public string Message { get; set; }     // ?????? ErrorMessage
    public List<string> Errors { get; set; }
}

public class Result<T> : Result
{
    public T? Data { get; set; }
}
```

### ????????? Result
```csharp
// ?????????????????
if (result.Success)
{
    // ??? result.Data
    // ???? result.Message (success message)
}
else
{
    // ???? result.Message (error message)
    // ???? result.Errors (list ??? errors)
}
```

---

## ?????????????????

### ? Create/Edit ?????????
- ???????????? PR, PO, GR ??????????????????
- Document Number ??? generate ?????????
- ?????? Created/Updated user ID

### ? Load ???????????????
- ?????????????????????????????
- ?????????? Items ???????????????

### ? Error Handling ?????
- ???? error message ?????????
- ?????????????????????????????????? error
- Dropdown ????????????????? error

### ? User Audit Trail
- ?????? userId ?????? Create/Update
- ??????????????????????????

---

## ????????

### Test Case: Create PR
1. ? ???????? `/Purchasing/PR/Info`
2. ? ?????????? header (Date, Department, Requestor)
3. ? Add items ???????? "Add Item"
4. ? ????? Item ??? dropdown
5. ? ???? Quantity, Price
6. ? ?? Submit
7. ? ?????????????????????????????????
8. ? Redirect ?? Index page ????? success message

### Test Case: Edit PR
1. ? ???????? `/Purchasing/PR/Info?id=1`
2. ? ?????????? PR ?????????
3. ? ???? Items ????????????
4. ? ???????????
5. ? ?? Submit
6. ? ?????????? update ??????

### Test Case: Validation Error
1. ? ????????????????
2. ? ?? Submit
3. ? ???? validation errors
4. ? ?????????????????????????
5. ? Dropdown items ????????????

---

## Build Status
? **Build ??????**  
? **????? compilation errors**  
? **??? Result class ??????????**  
? **???????????**

---

## ????????????
1. ? `EbikeRental.Web/Pages/Purchasing/PR/Info.cshtml.cs`
2. ? `EbikeRental.Web/Pages/Purchasing/PO/Info.cshtml.cs`
3. ? `EbikeRental.Web/Pages/Purchasing/GR/Info.cshtml.cs`

---

**?????:** ? ?????????????????  
**??????:** 2024-12-25  
**????????:** ????????????? Create/Edit ????
