# ?? ?????????? PR Items ????? Database

## ?? ??????????????

**?????????:** ASP.NET Core Model Binding ??????? **array index ???????????????** (0, 1, 2, 3...)

### ??????? row ????? ????????? row ????
```
???????????:  PR.Items[0], PR.Items[1], PR.Items[2]
?????? row ??? 1:  PR.Items[0], PR.Items[2]          ? ????????????? index 1
????? row ????:     PR.Items[0], PR.Items[2], PR.Items[3]  ? Model Binder ????????? index 1
```

**???????:** Model Binder bind ???????? `PR.Items[0]` ???????? ??????????? index 1

---

## ? ?????????

### ??????
?????????? **?????/?? row** ???? **reindex ??? row** ????? index ???????????? (0, 1, 2, 3...)

### ??????????? `updateRowNumbers()` ????

#### ? ???? - ???????????????????????
```javascript
function updateRowNumbers() {
    const rows = document.querySelectorAll('#prItemsBody tr');
    rows.forEach((row, index) => {
        const rowNum = row.querySelector('.row-number');
        if (rowNum) rowNum.textContent = index + 1;  // ?????????
    });
}
```

#### ? ???? - Reindex name attributes ????
```javascript
function updateRowNumbers() {
    const rows = document.querySelectorAll('#prItemsBody tr');
    rows.forEach((row, index) => {
        // 1. Update row number display
        const rowNum = row.querySelector('.row-number');
        if (rowNum) rowNum.textContent = index + 1;
        
        // 2. Reindex all input/select fields
        row.querySelectorAll('input, select').forEach(input => {
            if (input.name && input.name.includes('PR.Items[')) {
                // Extract property name: "PR.Items[2].ItemId" -> ".ItemId"
                const propertyMatch = input.name.match(/\]\.(.*)/);
                if (propertyMatch) {
                    // Rebuild with new index: "PR.Items[0].ItemId"
                    input.name = `PR.Items[${index}].${propertyMatch[1]}`;
                }
            }
        });
    });
}
```

### ????????????????

**Scenario:** ?? 3 rows ? ?? row ??? 2 ? ????? row ????

```
1. ???????? (3 rows)
   Row 0: PR.Items[0].ItemId, PR.Items[0].Quantity, ...
   Row 1: PR.Items[1].ItemId, PR.Items[1].Quantity, ...
   Row 2: PR.Items[2].ItemId, PR.Items[2].Quantity, ...

2. ?? row ??? 1
   Row 0: PR.Items[0].ItemId, PR.Items[0].Quantity, ...
   Row 2: PR.Items[2].ItemId, PR.Items[2].Quantity, ...  ? ??????????

3. ????? updateRowNumbers()
   Row 0: PR.Items[0].ItemId, PR.Items[0].Quantity, ...
   Row 1: PR.Items[1].ItemId, PR.Items[1].Quantity, ...  ? Reindex ??? 2 ? 1

4. ????? row ????
   Row 0: PR.Items[0].ItemId, ...
   Row 1: PR.Items[1].ItemId, ...
   Row 2: PR.Items[2].ItemId, ...  ? Index ?????????

5. Submit form
   ? Model Binder bind ?????????? 3 items
```

---

## ?? ?????????????

### 1. Purchase Requisition (PR)

#### ????? `addPRItemRow()`
```javascript
// ? ???? - ??? rowIndex ???????????????????
let rowIndex = @(Model.PR.Items?.Count ?? 0);
function addPRItemRow() {
    rowIndex++;  // 0, 1, 2, 3, 4... (???????????? row)
    ...
}

// ? ???? - ???????? rows ????????
function addPRItemRow() {
    const currentRowCount = tbody.querySelectorAll('tr').length;  // 0, 1, 2, 2, 3...
    // ??????? reindex ?????? 0, 1, 2
    ...
}
```

#### ????????????? reindex
```javascript
function updateRowNumbers() {
    const rows = document.querySelectorAll('#prItemsBody tr');
    rows.forEach((row, index) => {
        // Update display number
        const rowNum = row.querySelector('.row-number');
        if (rowNum) rowNum.textContent = index + 1;
        
        // Reindex name attributes
        row.querySelectorAll('input, select').forEach(input => {
            if (input.name && input.name.includes('PR.Items[')) {
                const propertyMatch = input.name.match(/\]\.(.*)/);
                if (propertyMatch) {
                    input.name = `PR.Items[${index}].${propertyMatch[1]}`;
                }
            }
        });
    });
}
```

#### ????? updateRowNumbers() ??????? add/remove
```javascript
function addPRItemRow() {
    ...
    tbody.appendChild(newRow);
    updateRowNumbers();  // ? Reindex
    calculateGrandTotal();
}

function removePRItemRow(button) {
    button.closest('tr').remove();
    updateRowNumbers();  // ? Reindex
    calculateGrandTotal();
}
```

---

### 2. Purchase Order (PO)

????????????????:
- ? ???????? `rowIndex`
- ? ??? `currentRowCount` ?? `addPOItemRow()`
- ? ????? reindex logic ?? `updatePORowNumbers()`

```javascript
function updatePORowNumbers() {
    const rows = document.querySelectorAll('#poItemsBody tr');
    rows.forEach((row, index) => {
        const rowNum = row.querySelector('.row-number');
        if (rowNum) rowNum.textContent = index + 1;
        
        row.querySelectorAll('input, select').forEach(input => {
            if (input.name && input.name.includes('PO.Items[')) {
                const propertyMatch = input.name.match(/\]\.(.*)/);
                if (propertyMatch) {
                    input.name = `PO.Items[${index}].${propertyMatch[1]}`;
                }
            }
        });
    });
}
```

---

### 3. Goods Receipt (GR)

????????????????:
- ? ???????? `rowIndex`
- ? ??? `currentRowCount` ?? `addGRItemRow()`
- ? ????? reindex logic ?? `updateGRRowNumbers()`

```javascript
function updateGRRowNumbers() {
    const rows = document.querySelectorAll('#grItemsBody tr');
    rows.forEach((row, index) => {
        const rowNum = row.querySelector('.row-number');
        if (rowNum) rowNum.textContent = index + 1;
        
        row.querySelectorAll('input, select').forEach(input => {
            if (input.name && input.name.includes('GR.Items[')) {
                const propertyMatch = input.name.match(/\]\.(.*)/);
                if (propertyMatch) {
                    input.name = `GR.Items[${index}].${propertyMatch[1]}`;
                }
            }
        });
    });
}
```

---

## ?? ???????

| Scenario | ??????? | ??????? |
|----------|---------|----------|
| **????? 3 items** | ? ????????? 3 items | ? ????????? 3 items |
| **????? 3 items, ?? item ??? 2** | ? ???????????? 1 item | ? ????????? 2 items |
| **?????-??-????????????** | ? ???????????? | ? ???????????? items |
| **Edit PR ????? items** | ? ??????? | ? ??????? |
| **Edit + ?? item ?????** | ? Update ?????? | ? Update ??? |

---

## ?? ????????

### Test Case 1: ????? Items ????
1. ? ???????? Create PR
2. ? Add 3 items
3. ? Save
4. ? ??????? database: ?????? 3 items

### Test Case 2: ?? Item ?????
1. ? ???????? Create PR
2. ? Add 4 items (index 0, 1, 2, 3)
3. ? ?? item ??? 2 (?? index 1)
4. ? Browser Console: ??????? name attributes ???? reindex ???? 0, 1, 2
5. ? Save
6. ? ??????? database: ?????? 3 items

### Test Case 3: Edit ????? Items
1. ? ???????? Edit PR ????? 5 items
2. ? ?? item ??? 2 ??? 4
3. ? Add 2 items ????
4. ? Save
5. ? ??????? database: ?????? 5 items (3 ???? + 2 ????)

### Test Case 4: ?????????????????
1. ? Add 2 items
2. ? ?? item ???
3. ? Add 1 item
4. ? ?? item ????
5. ? Add 2 items
6. ? Save
7. ? ??????? database: ???????????????? items ????????????

---

## ?? Key Points

### ???????? Reindex?
ASP.NET Core Model Binding ??? **sequential index algorithm**:
- ???? `Items[0]`, `Items[1]`, `Items[2]`, ...
- ???????????????? (???? ????? `Items[1]`) ? **?????????**
- Items ???????????????? bind

### Regular Expression Breakdown
```javascript
const propertyMatch = input.name.match(/\]\.(.*)/);
```
- `\]` - ?? closing bracket `]`
- `\.` - ?? dot `.`
- `(.*)` - capture ???????????????? (property name)
- **????????:** `"PR.Items[2].ItemId"` ? match `".ItemId"`

### ????????? Template String
```javascript
input.name = `PR.Items[${index}].${propertyMatch[1]}`;
```
- `${index}` - new index (0, 1, 2, ...)
- `${propertyMatch[1]}` - property name ??? capture ???

---

## ?? ????????????

1. ? `EbikeRental.Web/Pages/Purchasing/PR/Info.cshtml` - JavaScript section
2. ? `EbikeRental.Web/Pages/Purchasing/PO/Info.cshtml` - JavaScript section
3. ? `EbikeRental.Web/Pages/Purchasing/GR/Info.cshtml` - JavaScript section

---

## ?? Build Status

? **Build ??????**  
? **Hot Reload ready** (???? Stop ??? Run ????)  
? **??????????**

---

## ?? Best Practices ?????? Dynamic Forms

### 1. ???? Reindex ???? Add/Remove
```javascript
function addRow() {
    // ... add logic
    reindexRows();
}

function removeRow() {
    // ... remove logic
    reindexRows();
}
```

### 2. ??? currentRowCount ??? global counter
```javascript
// ? ?????
let rowIndex = 0;
function addRow() {
    rowIndex++;  // ???????????????????????
}

// ? ??
function addRow() {
    const count = tbody.querySelectorAll('tr').length;  // ???????
}
```

### 3. Test ???? Browser DevTools
???? Network tab ? Submit form ? ?? Form Data ??? index ????????????????

---

**?????:** ? ?????????????????  
**??????:** 2024-12-25  
**Impact:** PR, PO, GR ???????
