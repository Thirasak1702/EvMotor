@page
@model EbikeRental.Web.Pages.Masters.BOM.InfoModel
@{
	ViewData["Title"] = Model.Bom.Id == 0 ? "New BOM" : "Edit BOM";
	ViewData["FormTitle"] = ViewData["Title"];
	ViewData["FormIcon"] = "bi-diagram-3";
}

<partial name="_FormCardLayout" />

<form method="post" id="info-form">
	<div asp-validation-summary="ModelOnly" class="text-red-600 mb-4 text-sm"></div>
	<input type="hidden" asp-for="Bom.Id" />

	<!-- BOM Header Section -->
	<div class="mb-6">
		<h3 class="text-base font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
			<i class="bi bi-info-circle mr-2"></i>BOM Header
		</h3>
		
		<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
			<div>
				<label asp-for="Bom.BomCode" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-upc-scan mr-1"></i>BOM Code <span class="text-red-600">*</span>
				</label>
				@if (Model.Bom.Id == 0)
				{
					<input asp-for="Bom.BomCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" value="Auto-generated" readonly />
					<span class="text-xs text-gray-500 mt-1 block">
						<i class="bi bi-info-circle-fill mr-1"></i>Auto-generated when saved
					</span>
				}
				else
				{
					<input asp-for="Bom.BomCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
				}
				<span asp-validation-for="Bom.BomCode" class="text-red-600 text-sm mt-1 block"></span>
			</div>

			<div>
				<label asp-for="Bom.ParentItemId" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-box-seam mr-1"></i>Parent Item (Product) <span class="text-red-600">*</span>
				</label>
				<select asp-for="Bom.ParentItemId" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
					<option value="">-- Select Product --</option>
					@foreach (var item in Model.Items)
					{
						<option value="@item.Id">@item.Code - @item.Name</option>
					}
				</select>
				<span asp-validation-for="Bom.ParentItemId" class="text-red-600 text-sm mt-1 block"></span>
			</div>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
			<div class="md:col-span-2">
				<label asp-for="Bom.Description" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-file-text mr-1"></i>Description <span class="text-red-600">*</span>
				</label>
				<input asp-for="Bom.Description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter BOM description..." required />
				<span asp-validation-for="Bom.Description" class="text-red-600 text-sm mt-1 block"></span>
			</div>
			<div>
				<label asp-for="Bom.Version" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-tag mr-1"></i>Version
				</label>
				<input asp-for="Bom.Version" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 1.0, 2.0" />
				<span asp-validation-for="Bom.Version" class="text-red-600 text-sm mt-1 block"></span>
			</div>
		</div>
	</div>

	<!-- Validity & Status Section -->
	<div class="mb-6">
		<h3 class="text-base font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
			<i class="bi bi-calendar-check mr-2"></i>Validity & Status
		</h3>
		
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
			<div>
				<label asp-for="Bom.EffectiveDate" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-calendar-plus mr-1"></i>Effective Date
				</label>
				<input asp-for="Bom.EffectiveDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" type="date" />
				<span asp-validation-for="Bom.EffectiveDate" class="text-red-600 text-sm mt-1 block"></span>
				<span class="text-xs text-gray-500 mt-1 block">When this BOM becomes active</span>
			</div>
			<div>
				<label asp-for="Bom.ExpiryDate" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-calendar-x mr-1"></i>Expiry Date
				</label>
				<input asp-for="Bom.ExpiryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" type="date" />
				<span asp-validation-for="Bom.ExpiryDate" class="text-red-600 text-sm mt-1 block"></span>
				<span class="text-xs text-gray-500 mt-1 block">Optional expiration date</span>
			</div>
			<div>
				<label asp-for="Bom.IsActive" class="block text-sm font-medium text-gray-700 mb-2">
					<i class="bi bi-toggle-on mr-1"></i>Status
				</label>
				<select asp-for="Bom.IsActive" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
					<option value="true">Active</option>
					<option value="false">Inactive</option>
				</select>
			</div>
		</div>
		
		<div>
			<label asp-for="Bom.Notes" class="block text-sm font-medium text-gray-700 mb-2">
				<i class="bi bi-sticky mr-1"></i>Notes
			</label>
			<textarea asp-for="Bom.Notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Additional notes about this BOM..."></textarea>
		</div>
	</div>

	<hr class="my-6 border-gray-200" />

	<!-- Tabs Navigation -->
	<div class="mb-6">
		<div class="border-b border-gray-200">
			<nav class="-mb-px flex space-x-8" aria-label="Tabs">
				<button type="button" 
						onclick="showTab('materials')"
						id="tab-btn-materials"
						class="tab-button active border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">
					<i class="bi bi-list-ul mr-2"></i>
					Materials
				</button>
				<button type="button"
						onclick="showTab('processes')"
						id="tab-btn-processes"
						class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
					<i class="bi bi-gear mr-2"></i>
					Processes
				</button>
				<button type="button"
						onclick="showTab('qc')"
						id="tab-btn-qc"
						class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
					<i class="bi bi-check-circle mr-2"></i>
					QC Steps
				</button>
			</nav>
		</div>

		<!-- Tab Content: Materials -->
		<div id="tab-content-materials" class="tab-content mt-4">
			<div class="flex items-center justify-between mb-3">
				<h5 class="mb-0 text-base font-semibold text-gray-800 flex items-center gap-2">
					<i class="bi bi-list-ul"></i>
					<span>BOM Materials</span>
				</h5>
				<button type="button"
						class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
						onclick="addBomItemRow()">
					<i class="bi bi-plus-circle"></i>
					<span>Add Material</span>
				</button>
			</div>

			<div class="overflow-x-auto border border-gray-200 rounded-lg">
				<table class="min-w-full text-sm">
					<thead class="bg-gray-50 text-gray-700">
						<tr>
							<th class="px-3 py-2 text-left w-[5%]">#</th>
							<th class="px-3 py-2 text-left w-[25%]">Materials Item</th>
							<th class="px-3 py-2 text-left w-[15%]">Quantity</th>
							<th class="px-3 py-2 text-left w-[10%]">UOM</th>
							<th class="px-3 py-2 text-left w-[10%]">Scrap %</th>
							<th class="px-3 py-2 text-left w-[25%]">Notes</th>
							<th class="px-3 py-2 text-left w-[10%]">Actions</th>
						</tr>
					</thead>
					<tbody id="bomItemsBody" class="divide-y divide-gray-200 bg-white">
						@if (Model.Bom.BomItems != null && Model.Bom.BomItems.Any())
						{
							@for (int i = 0; i < Model.Bom.BomItems.Count; i++)
							{
								<tr>
									<td class="px-3 py-2 align-top">
										<input type="hidden" data-field="Id" name="Bom.BomItems[@i].Id" value="@Model.Bom.BomItems[i].Id" />
										<input type="text" data-field="Sequence" name="Bom.BomItems[@i].Sequence" value="@Model.Bom.BomItems[i].Sequence" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
									</td>
									<td class="px-3 py-2 align-top">
										<select data-field="ComponentItemId" name="Bom.BomItems[@i].ComponentItemId" class="w-full px-2 py-1 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
											<option value="">-- Select --</option>
											@foreach (var item in Model.Items)
											{
												<option value="@item.Id" selected="@(item.Id == Model.Bom.BomItems[i].ComponentItemId)">@item.Code - @item.Name</option>
											}
										</select>
									</td>
									<td class="px-3 py-2 align-top">
										<input type="number" data-field="Quantity" name="Bom.BomItems[@i].Quantity" value="@Model.Bom.BomItems[i].Quantity" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field="UnitOfMeasure" name="Bom.BomItems[@i].UnitOfMeasure" value="@Model.Bom.BomItems[i].UnitOfMeasure" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="number" data-field="ScrapPercentage" name="Bom.BomItems[@i].ScrapPercentage" value="@Model.Bom.BomItems[i].ScrapPercentage" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field="Notes" name="Bom.BomItems[@i].Notes" value="@Model.Bom.BomItems[i].Notes" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
									</td>
									<td class="px-3 py-2 align-top">
										<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomItemRow(this)" title="Remove">
											<i class="bi bi-trash"></i>
										</button>
									</td>
								</tr>
							}
						}
					</tbody>
				</table>
			</div>
		</div>

		<!-- Tab Content: Processes -->
		<div id="tab-content-processes" class="tab-content hidden mt-4">
			<div class="flex items-center justify-between mb-3">
				<h5 class="mb-0 text-base font-semibold text-gray-800 flex items-center gap-2">
					<i class="bi bi-gear"></i>
					<span>BOM Processes</span>
				</h5>
				<button type="button"
						class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
						onclick="addBomProcessRow()">
					<i class="bi bi-plus-circle"></i>
					<span>Add Process</span>
				</button>
			</div>

			<div class="overflow-x-auto border border-gray-200 rounded-lg">
				<table class="min-w-full text-sm">
					<thead class="bg-gray-50 text-gray-700">
						<tr>
							<th class="px-3 py-2 text-left w-[5%]">#</th>
							<th class="px-3 py-2 text-left w-[20%]">Work Code <span class="text-red-600">*</span></th>
							<th class="px-3 py-2 text-left w-[25%]">Work Name <span class="text-red-600">*</span></th>
							<th class="px-3 py-2 text-left w-[10%]">Persons</th>
							<th class="px-3 py-2 text-left w-[10%]">Quantity</th>
							<th class="px-3 py-2 text-left w-[10%]">UOM</th>
							<th class="px-3 py-2 text-left w-[15%]">Notes</th>
							<th class="px-3 py-2 text-left w-[5%]">Actions</th>
						</tr>
					</thead>
					<tbody id="bomProcessesBody" class="divide-y divide-gray-200 bg-white">
						@if (Model.Bom.BomProcesses != null && Model.Bom.BomProcesses.Any())
						{
							@for (int i = 0; i < Model.Bom.BomProcesses.Count; i++)
							{
								<tr>
									<td class="px-3 py-2 align-top">
										<input type="hidden" data-field-process="Id" name="Bom.BomProcesses[@i].Id" value="@Model.Bom.BomProcesses[i].Id" />
										<input type="text" data-field-process="Sequence" name="Bom.BomProcesses[@i].Sequence" value="@Model.Bom.BomProcesses[i].Sequence" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-process="WorkCode" name="Bom.BomProcesses[@i].WorkCode" value="@Model.Bom.BomProcesses[i].WorkCode" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., ASSY-001" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-process="WorkName" name="Bom.BomProcesses[@i].WorkName" value="@Model.Bom.BomProcesses[i].WorkName" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Assembly Process" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="number" data-field-process="NumberOfPersons" name="Bom.BomProcesses[@i].NumberOfPersons" value="@Model.Bom.BomProcesses[i].NumberOfPersons" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" min="0" />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="number" data-field-process="Quantity" name="Bom.BomProcesses[@i].Quantity" value="@Model.Bom.BomProcesses[i].Quantity" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.0001" min="0" />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-process="UnitOfMeasure" name="Bom.BomProcesses[@i].UnitOfMeasure" value="@Model.Bom.BomProcesses[i].UnitOfMeasure" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Hour" />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-process="Notes" name="Bom.BomProcesses[@i].Notes" value="@Model.Bom.BomProcesses[i].Notes" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
									</td>
									<td class="px-3 py-2 align-top">
										<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomProcessRow(this)" title="Remove">
											<i class="bi bi-trash"></i>
										</button>
									</td>
								</tr>
							}
						}
					</tbody>
				</table>
			</div>
		</div>

		<!-- Tab Content: QC -->
		<div id="tab-content-qc" class="tab-content hidden mt-4">
			<div class="flex items-center justify-between mb-3">
				<h5 class="mb-0 text-base font-semibold text-gray-800 flex items-center gap-2">
					<i class="bi bi-check-circle"></i>
					<span>BOM QC Steps</span>
				</h5>
				<button type="button"
						class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
						onclick="addBomQcRow()">
					<i class="bi bi-plus-circle"></i>
					<span>Add QC Step</span>
				</button>
			</div>

			<div class="overflow-x-auto border border-gray-200 rounded-lg">
				<table class="min-w-full text-sm">
					<thead class="bg-gray-50 text-gray-700">
						<tr>
							<th class="px-3 py-2 text-left w-[5%]">#</th>
							<th class="px-3 py-2 text-left w-[20%]">QC Code <span class="text-red-600">*</span></th>
							<th class="px-3 py-2 text-left w-[25%]">QC Name <span class="text-red-600">*</span></th>
							<th class="px-3 py-2 text-left w-[30%]">QC Values <span class="text-red-600">*</span></th>
							<th class="px-3 py-2 text-left w-[15%]">Notes</th>
							<th class="px-3 py-2 text-left w-[5%]">Actions</th>
						</tr>
					</thead>
					<tbody id="bomQcsBody" class="divide-y divide-gray-200 bg-white">
						@if (Model.Bom.BomQcs != null && Model.Bom.BomQcs.Any())
						{
							@for (int i = 0; i < Model.Bom.BomQcs.Count; i++)
							{
								<tr>
									<td class="px-3 py-2 align-top">
										<input type="hidden" data-field-qc="Id" name="Bom.BomQcs[@i].Id" value="@Model.Bom.BomQcs[i].Id" />
										<input type="text" data-field-qc="Sequence" name="Bom.BomQcs[@i].Sequence" value="@Model.Bom.BomQcs[i].Sequence" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-qc="QcCode" name="Bom.BomQcs[@i].QcCode" value="@Model.Bom.BomQcs[i].QcCode" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., QC-001" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-qc="QcName" name="Bom.BomQcs[@i].QcName" value="@Model.Bom.BomQcs[i].QcName" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Visual Inspection" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-qc="QcValues" name="Bom.BomQcs[@i].QcValues" value="@Model.Bom.BomQcs[i].QcValues" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Temperature: 20-25°C" required />
									</td>
									<td class="px-3 py-2 align-top">
										<input type="text" data-field-qc="Notes" name="Bom.BomQcs[@i].Notes" value="@Model.Bom.BomQcs[i].Notes" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
									</td>
									<td class="px-3 py-2 align-top">
										<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomQcRow(this)" title="Remove">
											<i class="bi bi-trash"></i>
										</button>
									</td>
								</tr>
							}
						}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</form>

<partial name="_FormCardLayoutEnd" />

@section Scripts {
	<partial name="_ValidationScriptsPartial" />

	<script>
		let itemsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
			Model.Items,
			new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }
		));

		function addBomItemRow() {
			const tbody = document.getElementById('bomItemsBody');
			const newRow = document.createElement('tr');
			let itemOptions = '<option value="">-- Select --</option>';
			itemsData.forEach(item => {
				itemOptions += `<option value="${item.id}">${item.code} - ${item.name}</option>`;
			});
			newRow.innerHTML = `
				<td class="px-3 py-2 align-top">
					<input type="hidden" data-field="Id" value="0" />
					<input type="text" data-field="Sequence" value="" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
				</td>
				<td class="px-3 py-2 align-top">
					<select data-field="ComponentItemId" class="w-full px-2 py-1 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
						${itemOptions}
					</select>
				</td>
				<td class="px-3 py-2 align-top">
					<input type="number" data-field="Quantity" value="1" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" required />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field="UnitOfMeasure" value="EA" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="number" data-field="ScrapPercentage" value="0" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field="Notes" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
				</td>
				<td class="px-3 py-2 align-top">
					<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomItemRow(this)" title="Remove">
						<i class="bi bi-trash"></i>
					</button>
				</td>
			`;
			tbody.appendChild(newRow);
			reindexBomItems();
		}

		function removeBomItemRow(button) {
			button.closest('tr').remove();
			reindexBomItems();
		}

		function reindexBomItems() {
			const rows = document.querySelectorAll('#bomItemsBody tr');
			rows.forEach((row, index) => {
				setFieldName(row, 'Id', index);
				setFieldName(row, 'Sequence', index);
				setFieldName(row, 'ComponentItemId', index);
				setFieldName(row, 'Quantity', index);
				setFieldName(row, 'UnitOfMeasure', index);
				setFieldName(row, 'ScrapPercentage', index);
				setFieldName(row, 'Notes', index);
				const seq = row.querySelector('[data-field="Sequence"]');
				if (seq) seq.value = index + 1;
			});
		}

		function setFieldName(row, field, index) {
			const el = row.querySelector(`[data-field="${field}"]`);
			if (!el) return;
			el.name = `Bom.BomItems[${index}].${field}`;
		}

		document.addEventListener('DOMContentLoaded', () => {
			reindexBomItems();
			reindexBomProcesses();
			reindexBomQcs();
		});

		function showTab(tabName) {
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.add('hidden');
			});
			document.querySelectorAll('.tab-button').forEach(btn => {
				btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
				btn.classList.add('border-transparent', 'text-gray-500');
			});
			const selectedContent = document.getElementById(`tab-content-${tabName}`);
			if (selectedContent) {
				selectedContent.classList.remove('hidden');
			}
			const selectedButton = document.getElementById(`tab-btn-${tabName}`);
			if (selectedButton) {
				selectedButton.classList.add('active', 'border-blue-500', 'text-blue-600');
				selectedButton.classList.remove('border-transparent', 'text-gray-500');
			}
		}

		function addBomProcessRow() {
			const tbody = document.getElementById('bomProcessesBody');
			const newRow = document.createElement('tr');
			newRow.innerHTML = `
				<td class="px-3 py-2 align-top">
					<input type="hidden" data-field-process="Id" value="0" />
					<input type="text" data-field-process="Sequence" value="" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-process="WorkCode" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., ASSY-001" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-process="WorkName" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Assembly Process" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="number" data-field-process="NumberOfPersons" value="1" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" min="0" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="number" data-field-process="Quantity" value="1" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.0001" min="0" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-process="UnitOfMeasure" value="Hour" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Hour" />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-process="Notes" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
				</td>
				<td class="px-3 py-2 align-top">
					<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomProcessRow(this)" title="Remove">
						<i class="bi bi-trash"></i>
					</button>
				</td>
			`;
			tbody.appendChild(newRow);
			reindexBomProcesses();
		}

		function removeBomProcessRow(button) {
			button.closest('tr').remove();
			reindexBomProcesses();
		}

		function reindexBomProcesses() {
			const rows = document.querySelectorAll('#bomProcessesBody tr');
			rows.forEach((row, index) => {
				setFieldNameProcess(row, 'Id', index);
				setFieldNameProcess(row, 'Sequence', index);
				setFieldNameProcess(row, 'WorkCode', index);
				setFieldNameProcess(row, 'WorkName', index);
				setFieldNameProcess(row, 'NumberOfPersons', index);
				setFieldNameProcess(row, 'Quantity', index);
				setFieldNameProcess(row, 'UnitOfMeasure', index);
				setFieldNameProcess(row, 'Notes', index);
				const seq = row.querySelector('[data-field-process="Sequence"]');
				if (seq) seq.value = index + 1;
			});
		}

		function setFieldNameProcess(row, field, index) {
			const el = row.querySelector(`[data-field-process="${field}"]`);
			if (!el) return;
			el.name = `Bom.BomProcesses[${index}].${field}`;
		}

		function addBomQcRow() {
			const tbody = document.getElementById('bomQcsBody');
			const newRow = document.createElement('tr');
			newRow.innerHTML = `
				<td class="px-3 py-2 align-top">
					<input type="hidden" data-field-qc="Id" value="0" />
					<input type="text" data-field-qc="Sequence" value="" class="w-20 px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-qc="QcCode" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., QC-001" required />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-qc="QcName" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Visual Inspection" required />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-qc="QcValues" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Temperature: 20-25°C" required />
				</td>
				<td class="px-3 py-2 align-top">
					<input type="text" data-field-qc="Notes" value="" class="w-full px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
				</td>
				<td class="px-3 py-2 align-top">
					<button type="button" class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" onclick="removeBomQcRow(this)" title="Remove">
						<i class="bi bi-trash"></i>
					</button>
				</td>
			`;
			tbody.appendChild(newRow);
			reindexBomQcs();
		}

		function removeBomQcRow(button) {
			button.closest('tr').remove();
			reindexBomQcs();
		}

		function reindexBomQcs() {
			const rows = document.querySelectorAll('#bomQcsBody tr');
			rows.forEach((row, index) => {
				setFieldNameQc(row, 'Id', index);
				setFieldNameQc(row, 'Sequence', index);
				setFieldNameQc(row, 'QcCode', index);
				setFieldNameQc(row, 'QcName', index);
				setFieldNameQc(row, 'QcValues', index);
				setFieldNameQc(row, 'Notes', index);
				const seq = row.querySelector('[data-field-qc="Sequence"]');
				if (seq) seq.value = index + 1;
			});
		}

		function setFieldNameQc(row, field, index) {
			const el = row.querySelector(`[data-field-qc="${field}"]`);
			if (!el) return;
			el.name = `Bom.BomQcs[${index}].${field}`;
		}
	</script>
}
